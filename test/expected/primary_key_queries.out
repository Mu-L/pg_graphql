begin;
    -- Set up test tables with different primary key configurations
    -- Table with single column integer primary key
    create table person(
        id int primary key,
        name text,
        email text
    );
    insert into public.person(id, name, email)
    values
        (1, 'Alice', 'alice@example.com'),
        (2, 'Bob', 'bob@example.com'),
        (3, 'Charlie', null);
    -- Table with multi-column primary key
    create table item(
        item_id int,
        product_id int,
        quantity int,
        price numeric(10,2),
        primary key(item_id, product_id)
    );
    insert into item(item_id, product_id, quantity, price)
    values
        (1, 101, 2, 10.99),
        (1, 102, 1, 24.99),
        (2, 101, 3, 10.99),
        (3, 103, 5, 5.99);
    -- Table with text primary key (instead of UUID)
    create table document(
        id text primary key,
        title text,
        content text
    );
    insert into document(id, title, content)
    values
        ('doc-1', 'Document 1', 'Content 1'),
        ('doc-2', 'Document 2', 'Content 2');
    savepoint a;
    -- Test 1: Query a person by primary key (single integer column)
    select jsonb_pretty(
        graphql.resolve($$
            {
              personByPk(id: 1) {
                id
                name
                email
              }
            }
        $$)
    );
               jsonb_pretty               
------------------------------------------
 {                                       +
     "data": {                           +
         "personByPk": {                 +
             "id": 1,                    +
             "name": "Alice",            +
             "email": "alice@example.com"+
         }                               +
     }                                   +
 }
(1 row)

    -- Test 2: Query a person by primary key with relationship
    select jsonb_pretty(
        graphql.resolve($$
            {
              personByPk(id: 2) {
                id
                name
                email
                nodeId
              }
            }
        $$)
    );
                       jsonb_pretty                       
----------------------------------------------------------
 {                                                       +
     "data": {                                           +
         "personByPk": {                                 +
             "id": 2,                                    +
             "name": "Bob",                              +
             "email": "bob@example.com",                 +
             "nodeId": "WyJwdWJsaWMiLCAicGVyc29uIiwgMl0="+
         }                                               +
     }                                                   +
 }
(1 row)

    -- Test 3: Query a non-existent person by primary key
    select jsonb_pretty(
        graphql.resolve($$
            {
              personByPk(id: 999) {
                id
                name
              }
            }
        $$)
    );
        jsonb_pretty        
----------------------------
 {                         +
     "data": {             +
         "personByPk": null+
     }                     +
 }
(1 row)

    -- Test 4: Query with multi-column primary key
    select jsonb_pretty(
        graphql.resolve($$
            {
              itemByPk(itemId: 1, productId: 102) {
                itemId
                productId
                quantity
                price
              }
            }
        $$)
    );
         jsonb_pretty          
-------------------------------
 {                            +
     "data": {                +
         "itemByPk": {        +
             "price": "24.99",+
             "itemId": 1,     +
             "quantity": 1,   +
             "productId": 102 +
         }                    +
     }                        +
 }
(1 row)

    -- Test 5: Query with multi-column primary key, one column value is incorrect
    select jsonb_pretty(
        graphql.resolve($$
            {
              itemByPk(itemId: 1, productId: 999) {
                itemId
                productId
                quantity
                price
              }
            }
        $$)
    );
       jsonb_pretty       
--------------------------
 {                       +
     "data": {           +
         "itemByPk": null+
     }                   +
 }
(1 row)

    -- Test 6: Query with text primary key
    select jsonb_pretty(
        graphql.resolve($$
            {
              documentByPk(id: "doc-1") {
                id
                title
                content
              }
            }
        $$)
    );
            jsonb_pretty            
------------------------------------
 {                                 +
     "data": {                     +
         "documentByPk": {         +
             "id": "doc-1",        +
             "title": "Document 1",+
             "content": "Content 1"+
         }                         +
     }                             +
 }
(1 row)

    -- Test 7: Using variables with primary key queries
    select jsonb_pretty(
        graphql.resolve($$
            query GetPerson($personId: Int!) {
              personByPk(id: $personId) {
                id
                name
                email
              }
            }
        $$, '{"personId": 3}')
    );
          jsonb_pretty          
--------------------------------
 {                             +
     "data": {                 +
         "personByPk": {       +
             "id": 3,          +
             "name": "Charlie",+
             "email": null     +
         }                     +
     }                         +
 }
(1 row)

    -- Test 8: Using variables with multi-column primary key queries
    select jsonb_pretty(
        graphql.resolve($$
            query GetItem($itemId: Int!, $productId: Int!) {
              itemByPk(itemId: $itemId, productId: $productId) {
                itemId
                productId
                quantity
                price
              }
            }
        $$, '{"itemId": 2, "productId": 101}')
    );
         jsonb_pretty          
-------------------------------
 {                            +
     "data": {                +
         "itemByPk": {        +
             "price": "10.99",+
             "itemId": 2,     +
             "quantity": 3,   +
             "productId": 101 +
         }                    +
     }                        +
 }
(1 row)

    -- Test 9: Error case - missing required primary key column
    select jsonb_pretty(
        graphql.resolve($$
            {
              itemByPk(itemId: 1) {
                itemId
                productId
              }
            }
        $$)
    );
                           jsonb_pretty                            
-------------------------------------------------------------------
 {                                                                +
     "data": null,                                                +
     "errors": [                                                  +
         {                                                        +
             "message": "All primary key columns must be provided"+
         }                                                        +
     ]                                                            +
 }
(1 row)

    -- Test 10: Using fragments with primary key queries
    select jsonb_pretty(
        graphql.resolve($$
            {
              personByPk(id: 1) {
                ...PersonFields
              }
            }

            fragment PersonFields on Person {
              id
              name
              email
            }
        $$)
    );
               jsonb_pretty               
------------------------------------------
 {                                       +
     "data": {                           +
         "personByPk": {                 +
             "id": 1,                    +
             "name": "Alice",            +
             "email": "alice@example.com"+
         }                               +
     }                                   +
 }
(1 row)

    -- Test 11: Query with null values in results
    select jsonb_pretty(
        graphql.resolve($$
            {
              personByPk(id: 3) {
                id
                name
                email
              }
            }
        $$)
    );
          jsonb_pretty          
--------------------------------
 {                             +
     "data": {                 +
         "personByPk": {       +
             "id": 3,          +
             "name": "Charlie",+
             "email": null     +
         }                     +
     }                         +
 }
(1 row)

    rollback to savepoint a;
    -- Set up tables with relationships for connection and function tests
    create table author(
        id int primary key,
        name text not null
    );
    create table book(
        id int primary key,
        title text not null,
        author_id int references author(id)
    );
    insert into author(id, name)
    values
        (1, 'Jane Austen'),
        (2, 'Charles Dickens'),
        (3, 'Mark Twain');
    insert into book(id, title, author_id)
    values
        (1, 'Pride and Prejudice', 1),
        (2, 'Sense and Sensibility', 1),
        (3, 'Emma', 1),
        (4, 'Oliver Twist', 2),
        (5, 'Great Expectations', 2),
        (6, 'Adventures of Tom Sawyer', 3);
    -- Create a function that extends the author type
    create function public._book_count(rec public.author)
        returns int
        stable
        language sql
    as $$
        select count(*)::int from book where author_id = rec.id
    $$;
    -- Create a function that returns text
    create function public._formatted_name(rec public.author)
        returns text
        immutable
        language sql
    as $$
        select 'Author: ' || rec.name
    $$;
    -- Test 12: nodeByPk with a nested function (scalar return)
    select jsonb_pretty(
        graphql.resolve($$
            {
              authorByPk(id: 1) {
                id
                name
                bookCount
                formattedName
              }
            }
        $$)
    );
                    jsonb_pretty                    
----------------------------------------------------
 {                                                 +
     "data": {                                     +
         "authorByPk": {                           +
             "id": 1,                              +
             "name": "Jane Austen",                +
             "bookCount": 3,                       +
             "formattedName": "Author: Jane Austen"+
         }                                         +
     }                                             +
 }
(1 row)

    -- Test 13: nodeByPk with a connection (one-to-many relationship)
    select jsonb_pretty(
        graphql.resolve($$
            {
              authorByPk(id: 1) {
                id
                name
                bookCollection {
                  edges {
                    node {
                      id
                      title
                    }
                  }
                }
              }
            }
        $$)
    );
                         jsonb_pretty                         
--------------------------------------------------------------
 {                                                           +
     "data": {                                               +
         "authorByPk": {                                     +
             "id": 1,                                        +
             "name": "Jane Austen",                          +
             "bookCollection": {                             +
                 "edges": [                                  +
                     {                                       +
                         "node": {                           +
                             "id": 1,                        +
                             "title": "Pride and Prejudice"  +
                         }                                   +
                     },                                      +
                     {                                       +
                         "node": {                           +
                             "id": 2,                        +
                             "title": "Sense and Sensibility"+
                         }                                   +
                     },                                      +
                     {                                       +
                         "node": {                           +
                             "id": 3,                        +
                             "title": "Emma"                 +
                         }                                   +
                     }                                       +
                 ]                                           +
             }                                               +
         }                                                   +
     }                                                       +
 }
(1 row)

    -- Test 14: nodeByPk with connection and pagination
    select jsonb_pretty(
        graphql.resolve($$
            {
              authorByPk(id: 1) {
                id
                name
                bookCollection(first: 2) {
                  pageInfo {
                    hasNextPage
                    hasPreviousPage
                  }
                  edges {
                    node {
                      id
                      title
                    }
                  }
                }
              }
            }
        $$)
    );
                         jsonb_pretty                         
--------------------------------------------------------------
 {                                                           +
     "data": {                                               +
         "authorByPk": {                                     +
             "id": 1,                                        +
             "name": "Jane Austen",                          +
             "bookCollection": {                             +
                 "edges": [                                  +
                     {                                       +
                         "node": {                           +
                             "id": 1,                        +
                             "title": "Pride and Prejudice"  +
                         }                                   +
                     },                                      +
                     {                                       +
                         "node": {                           +
                             "id": 2,                        +
                             "title": "Sense and Sensibility"+
                         }                                   +
                     }                                       +
                 ],                                          +
                 "pageInfo": {                               +
                     "hasNextPage": true,                    +
                     "hasPreviousPage": false                +
                 }                                           +
             }                                               +
         }                                                   +
     }                                                       +
 }
(1 row)

    -- Test 15: nodeByPk with connection filter
    select jsonb_pretty(
        graphql.resolve($$
            {
              authorByPk(id: 1) {
                id
                name
                bookCollection(filter: {title: {like: "%Pride%"}}) {
                  edges {
                    node {
                      id
                      title
                    }
                  }
                }
              }
            }
        $$)
    );
                        jsonb_pretty                        
------------------------------------------------------------
 {                                                         +
     "data": {                                             +
         "authorByPk": {                                   +
             "id": 1,                                      +
             "name": "Jane Austen",                        +
             "bookCollection": {                           +
                 "edges": [                                +
                     {                                     +
                         "node": {                         +
                             "id": 1,                      +
                             "title": "Pride and Prejudice"+
                         }                                 +
                     }                                     +
                 ]                                         +
             }                                             +
         }                                                 +
     }                                                     +
 }
(1 row)

    -- Test 16: nodeByPk with connection ordering
    select jsonb_pretty(
        graphql.resolve($$
            {
              authorByPk(id: 1) {
                id
                name
                bookCollection(orderBy: [{title: DescNullsLast}]) {
                  edges {
                    node {
                      id
                      title
                    }
                  }
                }
              }
            }
        $$)
    );
                         jsonb_pretty                         
--------------------------------------------------------------
 {                                                           +
     "data": {                                               +
         "authorByPk": {                                     +
             "id": 1,                                        +
             "name": "Jane Austen",                          +
             "bookCollection": {                             +
                 "edges": [                                  +
                     {                                       +
                         "node": {                           +
                             "id": 2,                        +
                             "title": "Sense and Sensibility"+
                         }                                   +
                     },                                      +
                     {                                       +
                         "node": {                           +
                             "id": 1,                        +
                             "title": "Pride and Prejudice"  +
                         }                                   +
                     },                                      +
                     {                                       +
                         "node": {                           +
                             "id": 3,                        +
                             "title": "Emma"                 +
                         }                                   +
                     }                                       +
                 ]                                           +
             }                                               +
         }                                                   +
     }                                                       +
 }
(1 row)

    -- Test 17: nodeByPk with both function and connection
    select jsonb_pretty(
        graphql.resolve($$
            {
              authorByPk(id: 2) {
                id
                name
                bookCount
                formattedName
                bookCollection {
                  edges {
                    node {
                      id
                      title
                    }
                  }
                }
              }
            }
        $$)
    );
                       jsonb_pretty                        
-----------------------------------------------------------
 {                                                        +
     "data": {                                            +
         "authorByPk": {                                  +
             "id": 2,                                     +
             "name": "Charles Dickens",                   +
             "bookCount": 2,                              +
             "formattedName": "Author: Charles Dickens",  +
             "bookCollection": {                          +
                 "edges": [                               +
                     {                                    +
                         "node": {                        +
                             "id": 4,                     +
                             "title": "Oliver Twist"      +
                         }                                +
                     },                                   +
                     {                                    +
                         "node": {                        +
                             "id": 5,                     +
                             "title": "Great Expectations"+
                         }                                +
                     }                                    +
                 ]                                        +
             }                                            +
         }                                                +
     }                                                    +
 }
(1 row)

    -- Test 18: nodeByPk with nested relationship (book -> author)
    select jsonb_pretty(
        graphql.resolve($$
            {
              bookByPk(id: 1) {
                id
                title
                author {
                  id
                  name
                  bookCount
                }
              }
            }
        $$)
    );
                jsonb_pretty                 
---------------------------------------------
 {                                          +
     "data": {                              +
         "bookByPk": {                      +
             "id": 1,                       +
             "title": "Pride and Prejudice",+
             "author": {                    +
                 "id": 1,                   +
                 "name": "Jane Austen",     +
                 "bookCount": 3             +
             }                              +
         }                                  +
     }                                      +
 }
(1 row)

    -- Test 19: nodeByPk with deeply nested connection
    select jsonb_pretty(
        graphql.resolve($$
            {
              bookByPk(id: 4) {
                id
                title
                author {
                  id
                  name
                  bookCollection {
                    edges {
                      node {
                        id
                        title
                      }
                    }
                  }
                }
              }
            }
        $$)
    );
                         jsonb_pretty                          
---------------------------------------------------------------
 {                                                            +
     "data": {                                                +
         "bookByPk": {                                        +
             "id": 4,                                         +
             "title": "Oliver Twist",                         +
             "author": {                                      +
                 "id": 2,                                     +
                 "name": "Charles Dickens",                   +
                 "bookCollection": {                          +
                     "edges": [                               +
                         {                                    +
                             "node": {                        +
                                 "id": 4,                     +
                                 "title": "Oliver Twist"      +
                             }                                +
                         },                                   +
                         {                                    +
                             "node": {                        +
                                 "id": 5,                     +
                                 "title": "Great Expectations"+
                             }                                +
                         }                                    +
                     ]                                        +
                 }                                            +
             }                                                +
         }                                                    +
     }                                                        +
 }
(1 row)

    -- Test 20: nodeByPk returning null with connection (non-existent author)
    select jsonb_pretty(
        graphql.resolve($$
            {
              authorByPk(id: 999) {
                id
                name
                bookCollection {
                  edges {
                    node {
                      id
                      title
                    }
                  }
                }
              }
            }
        $$)
    );
        jsonb_pretty        
----------------------------
 {                         +
     "data": {             +
         "authorByPk": null+
     }                     +
 }
(1 row)

    -- Test 21: nodeByPk with empty connection (author with no books)
    insert into author(id, name) values (4, 'New Author');
    select jsonb_pretty(
        graphql.resolve($$
            {
              authorByPk(id: 4) {
                id
                name
                bookCount
                bookCollection {
                  edges {
                    node {
                      id
                      title
                    }
                  }
                }
              }
            }
        $$)
    );
           jsonb_pretty            
-----------------------------------
 {                                +
     "data": {                    +
         "authorByPk": {          +
             "id": 4,             +
             "name": "New Author",+
             "bookCount": 0,      +
             "bookCollection": {  +
                 "edges": [       +
                 ]                +
             }                    +
         }                        +
     }                            +
 }
(1 row)

rollback;
